
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get a user's data from the 'users' collection.
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    // Helper function to check if a user is an exporter.
    function isExporter(userId) {
      return request.auth != null && getUserData(userId).userType == 'exporter';
    }

    // Helper function to check if a user is a carrier.
    function isCarrier(userId) {
      return request.auth != null && getUserData(userId).userType == 'carrier';
    }

    // Rules for the 'users' collection.
    match /users/{userId} {
      // Users can create their own document upon signup.
      allow create: if request.auth.uid == userId;
      // Users can read and update their own document (e.g., to set userType).
      allow read, update: if request.auth.uid == userId;
    }

    // Rules for the 'shipments' collection.
    match /shipments/{shipmentId} {
      // Exporters can create shipments. Any authenticated user can read them.
      allow create: if isExporter(request.auth.uid) && request.resource.data.exporterId == request.auth.uid;
      allow read: if request.auth != null;
      
      // Only the owning exporter can update their shipment (e.g., go live, award a bid).
      allow update: if isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid;

      // Rules for the 'bids' subcollection within a shipment.
      match /bids/{bidId} {
        // Carriers can place bids on 'live' shipments.
        allow create: if isCarrier(request.auth.uid) 
                      && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'live'
                      && request.resource.data.carrierId == request.auth.uid;

        // An exporter can read bids for their own shipments.
        // Any carrier can read bids for any shipment to see live bidding data.
        allow read: if (isExporter(request.auth.uid) && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.exporterId == request.auth.uid)
                    || isCarrier(request.auth.uid);
      }
    }
  }
}
