rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ──────── Helper Functions ────────
    function isExporter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'exporter';
    }

    function isCarrier(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'carrier';
    }

    // ──────── Users Collection ────────
    match /users/{userId} {
      allow get: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null 
                    && request.auth.uid == userId 
                    && request.resource.data.email == request.auth.token.email;
      allow list, delete: if false;

      match /register/{shipmentId} {
        // Allow a carrier to read their interests at any time
        allow read: if request.auth != null
                    && isCarrier(request.auth.uid)
                    && request.auth.uid == userId;

        // Allow a carrier to create an interest only if the shipment is scheduled
        allow create: if request.auth != null
                      && isCarrier(request.auth.uid)
                      && request.auth.uid == userId
                      && get(/databases/$(database)/documents/shipments/$(shipmentId)).exists()
                      && get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'scheduled';

        allow update, delete: if false;
      }
    }

    // ──────── Shipments Collection ────────
    match /shipments/{shipmentId} {
      allow read: if request.auth != null;

      allow create: if request.auth != null
                  && isExporter(request.auth.uid)
                  && request.resource.data.exporterId == request.auth.uid;

      allow update: if request.auth != null
                  && isExporter(request.auth.uid)
                  && resource.data.exporterId == request.auth.uid
                  && (
                    ((resource.data.status == 'draft' || resource.data.status == 'scheduled')
                      && request.resource.data.exporterId == resource.data.exporterId
                      && request.resource.data.createdAt == resource.data.createdAt) ||

                    ((resource.data.status == 'draft' || resource.data.status == 'scheduled')
                      && request.resource.data.status == 'live') ||

                    (resource.data.status == 'live'
                      && request.resource.data.status == 'awarded'
                      && request.resource.data.winningBidId != null)
                  );

      allow delete: if false;

      // ──────── Bids Subcollection ────────
      match /bids/{bidId} {
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/shipments/$(shipmentId)).exists() &&
          get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'live';

        allow create: if request.auth != null &&
          isCarrier(request.auth.uid) &&
          request.resource.data.carrierId == request.auth.uid &&
          get(/databases/$(database)/documents/shipments/$(shipmentId)).exists() &&
          get(/databases/$(database)/documents/shipments/$(shipmentId)).data.status == 'live';
        
        allow update, delete: if false;
      }
    }
  }
}
