
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isUserType(userId, userType) {
        return isAuthenticated() && getUserData(userId).userType == userType;
    }

    match /users/{userId} {
      // Users can create and update their own profile document.
      allow read, update, create: if isOwner(userId);
      allow delete: if false;
    }

    match /shipments/{shipmentId} {
      // Any authenticated user of type carrier or exporter can read.
      // Exporters will be restricted by client-side queries to only their own documents.
      allow read: if isUserType(request.auth.uid, 'carrier') || isUserType(request.auth.uid, 'exporter');

      // Exporters can create shipments, but must correctly set their own ID as the exporter.
      allow create: if isUserType(request.auth.uid, 'exporter') && request.resource.data.exporterId == request.auth.uid;

      // Only the original exporter can update or delete their shipment.
      allow update, delete: if isUserType(request.auth.uid, 'exporter') && resource.data.exporterId == request.auth.uid;
    }
  }
}
