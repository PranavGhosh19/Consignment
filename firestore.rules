rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ───── Helper Functions ─────
    function isExporter(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'exporter';
    }

    function isCarrier(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'carrier';
    }

    function isEmployee(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.userType == 'employee';
    }

    function getShipment(shipmentId) {
      return get(/databases/$(database)/documents/shipments/$(shipmentId));
    }

    function isRegistered(shipmentId, userId) {
      return exists(/databases/$(database)/documents/shipments/$(shipmentId)/register/$(userId));
    }

    // ───── Verification Logic (for Exporter & Carrier) ─────
    function isValidVerificationSubmission(requestData, resourceData, userId) {
      let baseFields = [
        'legalName',
        'gstin',
        'pan',
        'incorporationCertificateUrl',
        'incorporationCertificatePath'
      ];

      let exporterExtra = ['iecCode', 'adCode'];
      let carrierExtra = ['licenseNumber', 'companyType'];

      let userType =
        resourceData.userType != null
          ? resourceData.userType
          : (requestData.userType != null ? requestData.userType : null);

      let requiredKeys =
        userType == 'exporter'
          ? baseFields.concat(exporterExtra)
          : userType == 'carrier'
            ? baseFields.concat(carrierExtra)
            : baseFields;

      let hasAllKeys =
        requestData.companyDetails is map &&
        requestData.companyDetails.keys().hasAll(requiredKeys);

      let validPath =
        requestData.companyDetails.incorporationCertificatePath.matches(
          'verification-documents/' + userType + '/' + userId + '/.*'
        );

      return hasAllKeys && validPath;
    }

    // ───── USERS COLLECTION ─────
    match /users/{userId} {

      // READ — User or Employee
      allow get: if request.auth.uid == userId || isEmployee(request.auth.uid);
      allow list: if request.auth.uid != null &&
                  (isEmployee(request.auth.uid) || isExporter(request.auth.uid));

      // CREATE / UPDATE — User or Employee
      allow create, update: if request.auth != null &&
        (request.auth.uid == userId || isEmployee(request.auth.uid));

      // ───── COMPANY DETAILS SUBCOLLECTION ─────
      match /companyDetails/{detailId} {
        allow read, write: if request.auth != null &&
          (request.auth.uid == userId || isEmployee(request.auth.uid));

        allow create, update: if request.auth != null &&
          (request.auth.uid == userId || isEmployee(request.auth.uid)) &&
          isValidVerificationSubmission(request.resource.data, resource.data, userId);
      }
    }

    // ───── SHIPMENTS COLLECTION ─────
    match /shipments/{shipmentId} {

      // CREATE: Only exporter creating their own shipment
      allow create: if request.auth.uid != null
                    && isExporter(request.auth.uid)
                    && request.resource.data.exporterId == request.auth.uid;

      // READ / LIST: Exporter (owner), Employee, or Carrier
      allow get, list: if request.auth.uid != null && (
        isEmployee(request.auth.uid) ||
        (isExporter(request.auth.uid) && resource.data.exporterId == request.auth.uid) ||
        (isCarrier(request.auth.uid) && (resource.data.winningCarrierId == request.auth.uid || resource.data.status != 'delivered'))
      );

      // UPDATE: Exporter or Employee based on rules
      allow update: if request.auth.uid != null && (

        // Employees can update anything
        isEmployee(request.auth.uid) ||

        // Exporter updates
        (
          isExporter(request.auth.uid) &&
          resource.data.exporterId == request.auth.uid &&
          (

            // ① Exporter editing drafts or scheduled shipments
            (
              (resource.data.status == 'draft' || resource.data.status == 'scheduled') &&
              request.resource.data.exporterId == resource.data.exporterId &&
              request.resource.data.createdAt == resource.data.createdAt
            ) ||

            // ② Exporter awarding a live shipment
            (
              resource.data.status == 'live' &&
              request.resource.data.status == 'awarded' &&
              request.resource.data.winningBidId != null &&
              request.resource.data.winningCarrierId != null &&
              request.resource.data.exporterId == resource.data.exporterId &&
              request.resource.data.createdAt == resource.data.createdAt
            ) ||
            // ④ Exporter marking shipment as delivered
            (
              resource.data.status == 'awarded' &&
              request.resource.data.status == 'delivered' &&
              request.resource.data.keys().hasAll(['status']) &&
              request.resource.data.keys().size() == 1
            )
          )
        ) ||

        // Carrier updates
        (
          isCarrier(request.auth.uid) &&
          resource.data.winningCarrierId == request.auth.uid &&
          resource.data.status == 'awarded' &&
          (
             // ⑤ Carrier updating tracking status
            (
                request.resource.data.keys().hasAll(['trackingStatus']) &&
                request.resource.data.keys().size() == 1
            ) ||
            // ⑥ Carrier marking as delivered
            (
                request.resource.data.status == 'delivered' &&
                request.resource.data.keys().hasAll(['status', 'trackingStatus']) &&
                request.resource.data.keys().size() == 2
            )
          )
        )
      );

      // DELETE — Only exporter can delete draft
      allow delete: if request.auth.uid != null &&
        isExporter(request.auth.uid) &&
        resource.data.exporterId == request.auth.uid &&
        resource.data.status == 'draft';

      // ───── DOCUMENTS SUBCOLLECTION ─────
      match /documents/{documentId} {
        allow read, write: if request.auth.uid != null && (
          isEmployee(request.auth.uid) ||
          getShipment(shipmentId).data.exporterId == request.auth.uid ||
          getShipment(shipmentId).data.winningCarrierId == request.auth.uid
        );
      }

      // ───── CONTACTS SUBCOLLECTION ─────
      match /contacts/{contactUserId} {

        // READ: Employee, exporter, winning carrier
        allow read: if request.auth != null && (
          isEmployee(request.auth.uid) ||
          getShipment(shipmentId).data.exporterId == request.auth.uid ||
          getShipment(shipmentId).data.winningCarrierId == request.auth.uid
        );

        // WRITE: User writing their own data OR Employee
        allow write: if request.auth != null && (
          isEmployee(request.auth.uid) ||
          (
            request.auth.uid == contactUserId &&
            (
              // Exporter
              (
                contactUserId == getShipment(shipmentId).data.exporterId &&
                request.resource.data.keys().hasAll(['exporterFullName', 'exporterPhoneNumber']) &&
                request.resource.data.keys().size() == 2
              ) ||

              // Winning Carrier
              (
                contactUserId == getShipment(shipmentId).data.winningCarrierId &&
                request.resource.data.keys().hasAll(['carrierFullName', 'carrierPhoneNumber']) &&
                request.resource.data.keys().size() == 2
              )
            )
          )
        );
      }

      // ───── FEEDBACK SUBCOLLECTION ─────
      match /feedback/{userId} {
        allow create: if request.auth.uid == userId && 
                       isExporter(userId) &&
                       getShipment(shipmentId).data.exporterId == userId &&
                       getShipment(shipmentId).data.status == 'delivered';
                       
        allow read: if request.auth.uid != null && (
          isEmployee(request.auth.uid) ||
          getShipment(shipmentId).data.exporterId == request.auth.uid ||
          getShipment(shipmentId).data.winningCarrierId == request.auth.uid
        );
      }

      // ───── BIDS SUBCOLLECTION ─────
      match /bids/{bidId} {

        // READ
        allow read: if request.auth.uid != null && (
          isEmployee(request.auth.uid) ||
          (isExporter(request.auth.uid) &&
           getShipment(shipmentId).data.exporterId == request.auth.uid) ||
          (isCarrier(request.auth.uid) &&
           getShipment(shipmentId).data.status == 'live')
        );

        // CREATE — carrier placing bid
        allow create: if request.auth.uid != null &&
          isCarrier(request.auth.uid) &&
          request.resource.data.carrierId == request.auth.uid &&
          getShipment(shipmentId).data.status == 'live';
      }

      // ───── REGISTER SUBCOLLECTION ─────
      match /register/{carrierId} {

        // READ
        allow read: if request.auth.uid != null && (
          isEmployee(request.auth.uid) ||
          (isExporter(request.auth.uid) &&
           getShipment(shipmentId).data.exporterId == request.auth.uid) ||
          (isCarrier(request.auth.uid) && request.auth.uid == carrierId)
        );

        // CREATE — Carrier registering for scheduled shipment
        allow create: if request.auth.uid != null &&
          isCarrier(request.auth.uid) &&
          request.auth.uid == carrierId &&
          getShipment(shipmentId).data.status == 'scheduled';
      }
    }

    // ───── COLLECTION GROUP READ ACCESS ─────
    match /{documentPath=**}/register/{docId} {
      allow read: if request.auth.uid != null &&
                  isCarrier(request.auth.uid) &&
                  resource.data.carrierId == request.auth.uid;
    }

    match /{documentPath=**}/bids/{bidId} {
      allow read: if request.auth.uid != null &&
                  isCarrier(request.auth.uid) &&
                  resource.data.carrierId == request.auth.uid;
    }

    // ───── DEFAULT DENY ─────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
