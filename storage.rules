rules_version = '2';

// ─────────── STORAGE RULES ───────────
service firebase.storage {
  match /b/{bucket}/o {

    function isExporter(userId) {
      return get(/databases/(default)/documents/users/$(userId)).data.userType == 'exporter';
    }

    function isEmployee(userId) {
      return get(/databases/(default)/documents/users/$(userId)).data.userType == 'employee';
    }

    function isShipmentAwardedParty(shipmentId, userId) {
      let shipment = get(/databases/(default)/documents/shipments/$(shipmentId)).data;
      return shipment.exporterId == userId || shipment.awardedCarrierId == userId || isEmployee(userId);
    }

    // ───── Onboarding Documents ─────
    match /users/{userId}/onboardingDocuments/{fileName} {
      allow write: if request.auth.uid == userId && isExporter(request.auth.uid);
      allow read: if request.auth.uid == userId || isEmployee(request.auth.uid);
      allow delete: if request.auth.uid == userId || isEmployee(request.auth.uid);
    }

    // ───── Shipment Documents ─────
    match /shipments/{shipmentId}/documents/{fileName} {
      allow write: if isShipmentAwardedParty(shipmentId, request.auth.uid);
      allow read: if isShipmentAwardedParty(shipmentId, request.auth.uid);
      allow delete: if isShipmentAwardedParty(shipmentId, request.auth.uid);
    }

    // ───── Profile Pictures (Optional) ─────
    match /users/{userId}/profile/{fileName} {
      allow write: if request.auth.uid == userId;
      allow read: if request.auth != null;
    }

    // ───── Default Deny ─────
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
