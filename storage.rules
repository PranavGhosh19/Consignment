
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ───── Verification Documents ─────
    // Documents uploaded by users during onboarding/verification.
    match /verification-documents/{userId}/{allPaths=**} {

      // Helper: check if the current user is an employee by their email domain
      function isEmployee() {
        return request.auth != null && request.auth.token.email.matches('.*@shippingbattlefield\\.com$');
      }

      // Helper: check if the current user is the document owner (exporter or carrier)
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }

      // READ: Owner or employee can read
      allow read: if isOwner() || isEmployee();

      // WRITE: Only the owner (exporter or carrier) can upload their own verification docs
      allow write: if isOwner();
    }

    // ───── Shipment-Specific Documents ─────
    // These are documents uploaded after a shipment has been awarded.
    match /shipments/{shipmentId}/{allPaths=**} {

      // Helper: check if the user is an employee by their email domain
      function isEmployee() {
        return request.auth != null && request.auth.token.email.matches('.*@shippingbattlefield\\.com$');
      }

      // Helper: check if the user is a valid awarded party
      function isAwardedParty() {
        let shipment = get(/databases/(default)/documents/shipments/$(shipmentId)).data;
        return request.auth != null && shipment.status == 'awarded' &&
               (shipment.exporterId == request.auth.uid ||
                shipment.winningCarrierId == request.auth.uid);
      }

      // READ/WRITE: Allow if the user is an employee OR a party to the awarded shipment.
      allow read, write: if isEmployee() || isAwardedParty();
    }

    // ───── Default Deny Rule ─────
    // Explicitly deny all other access to prevent unauthorized file operations.
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
